<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Form Mapping & GTM Events</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Test Form Mapping & GTM Events</h1>
    
    <div class="test-section info">
        <h2>ğŸ“‹ Instrucciones de Prueba</h2>
        <p>1. Abre la consola del navegador (F12)</p>
        <p>2. Ejecuta los tests usando los botones de abajo</p>
        <p>3. Verifica que solo se envÃ­e 1 evento GTM por envÃ­o</p>
        <p>4. Confirma que todos los campos se mapeen correctamente a Zapier</p>
    </div>

    <div class="test-section">
        <h2>ğŸ” Verificar dataLayer</h2>
        <button onclick="checkDataLayer()">Verificar dataLayer</button>
        <button onclick="clearDataLayer()">Limpiar dataLayer</button>
        <div id="datalayer-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“ Llenar y Enviar Formulario</h2>
        <button onclick="testForm()">Llenar y Enviar Formulario</button>
        <button onclick="testMultipleSubmissions()">Probar EnvÃ­os MÃºltiples</button>
        <div id="form-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ¯ Verificar TrustedForm Token</h2>
        <button onclick="checkTrustedForm()">Verificar TrustedForm</button>
        <div id="trustedform-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š Resultados de Pruebas</h2>
        <div id="test-results"></div>
    </div>

    <script>
        // FunciÃ³n para verificar dataLayer
        function checkDataLayer() {
            const results = document.getElementById('datalayer-results');
            const leadSubmitEvents = window.dataLayer?.filter(item => item.event === 'lead_submit') || [];
            
            results.innerHTML = `
                <h3>ğŸ“ˆ DataLayer Status:</h3>
                <p><strong>Total eventos:</strong> ${window.dataLayer?.length || 0}</p>
                <p><strong>Eventos lead_submit:</strong> ${leadSubmitEvents.length}</p>
                <p><strong>Ãšltimo evento:</strong> ${leadSubmitEvents.length > 0 ? JSON.stringify(leadSubmitEvents[leadSubmitEvents.length - 1], null, 2) : 'Ninguno'}</p>
            `;
            
            console.log('ğŸ¯ Eventos lead_submit:', leadSubmitEvents.length);
            console.log('ğŸ“Š Todos los eventos:', window.dataLayer);
        }

        // FunciÃ³n para limpiar dataLayer
        function clearDataLayer() {
            if (window.dataLayer) {
                window.dataLayer.length = 0;
                document.getElementById('datalayer-results').innerHTML = '<p class="success">âœ… DataLayer limpiado</p>';
            }
        }

        // FunciÃ³n para llenar y enviar formulario
        function testForm() {
            const results = document.getElementById('form-results');
            const form = document.querySelector('#lead-form-mobile form, #lead-form-desktop form');
            
            if (!form) {
                results.innerHTML = '<p class="error">âŒ No se encontrÃ³ el formulario</p>';
                return;
            }

            // Llenar campos
            const fields = {
                'first_name': 'Test',
                'last_name': 'User',
                'email_address': 'test@example.com',
                'phone_home': '555-1234',
                'address': '123 Test St',
                'city': 'Test City',
                'state': 'CA',
                'zip_code': '90210'
            };

            Object.entries(fields).forEach(([name, value]) => {
                const input = form.querySelector(`[name="${name}"]`);
                if (input) {
                    input.value = value;
                    console.log(`âœ… Campo ${name} llenado con: ${value}`);
                } else {
                    console.log(`âŒ Campo ${name} no encontrado`);
                }
            });

            // Seleccionar radio button
            const radioReplace = form.querySelector('[name="repair_or_replace"][value="replace"]');
            if (radioReplace) {
                radioReplace.checked = true;
                console.log('âœ… Radio button "replace" seleccionado');
            }

            results.innerHTML = '<p class="info">ğŸ“ Formulario llenado. Verificando envÃ­o...</p>';

            // Enviar formulario
            setTimeout(() => {
                form.querySelector('button[type="submit"]').click();
                console.log('ğŸš€ Formulario enviado');
            }, 1000);
        }

        // FunciÃ³n para probar envÃ­os mÃºltiples
        function testMultipleSubmissions() {
            const results = document.getElementById('form-results');
            results.innerHTML = '<p class="info">ğŸ”„ Probando envÃ­os mÃºltiples...</p>';
            
            // Limpiar dataLayer primero
            clearDataLayer();
            
            // Llenar y enviar mÃºltiples veces
            setTimeout(() => testForm(), 500);
            setTimeout(() => testForm(), 1500);
            setTimeout(() => testForm(), 2500);
            
            // Verificar resultados despuÃ©s de 5 segundos
            setTimeout(() => {
                const leadSubmitEvents = window.dataLayer?.filter(item => item.event === 'lead_submit') || [];
                results.innerHTML = `
                    <p><strong>Eventos lead_submit enviados:</strong> ${leadSubmitEvents.length}</p>
                    <p class="${leadSubmitEvents.length === 1 ? 'success' : 'error'}">
                        ${leadSubmitEvents.length === 1 ? 'âœ… Solo 1 evento enviado (correcto)' : 'âŒ MÃºltiples eventos enviados (incorrecto)'}
                    </p>
                `;
            }, 5000);
        }

        // FunciÃ³n para verificar TrustedForm
        function checkTrustedForm() {
            const results = document.getElementById('trustedform-results');
            
            const trustedFormStatus = {
                windowTrustedForm: !!window.TrustedForm,
                getCertUrl: !!(window.TrustedForm && window.TrustedForm.getCertUrl),
                token: window.TrustedForm?.getCertUrl?.() || 'No disponible'
            };

            results.innerHTML = `
                <h3>ğŸ” TrustedForm Status:</h3>
                <p><strong>window.TrustedForm:</strong> ${trustedFormStatus.windowTrustedForm ? 'âœ… Disponible' : 'âŒ No disponible'}</p>
                <p><strong>getCertUrl method:</strong> ${trustedFormStatus.getCertUrl ? 'âœ… Disponible' : 'âŒ No disponible'}</p>
                <p><strong>Token actual:</strong> ${trustedFormStatus.token}</p>
            `;

            console.log('ğŸ” TrustedForm status:', trustedFormStatus);
        }

        // FunciÃ³n para ejecutar todas las pruebas
        function runAllTests() {
            console.log('ğŸ§ª Iniciando todas las pruebas...');
            checkDataLayer();
            checkTrustedForm();
            
            setTimeout(() => {
                testForm();
            }, 2000);
        }

        // Auto-ejecutar verificaciÃ³n inicial
        window.addEventListener('load', () => {
            console.log('ğŸš€ PÃ¡gina de pruebas cargada');
            checkDataLayer();
            checkTrustedForm();
        });
    </script>
</body>
</html>
